"""
Unit tests for Configuration API Routes.

Tests cover:
- Token saving and validation
- Model listing with caching
- Model selection
- Configuration status
- Token deletion
- Error handling
- Request validation
"""

import pytest
from fastapi.testclient import TestClient
from unittest.mock import Mock, AsyncMock, patch
from app import app
from services.config_service import ConfigService
from services.model_checker import ModelChecker
from routes.config_routes import get_config_service, get_model_checker


class TestConfigRoutes:
    """Test suite for configuration API routes"""
    
    @pytest.fixture(autouse=True)
    def setup_teardown(self):
        """Setup and teardown for each test"""
        yield
        # Clear dependency overrides after each test
        app.dependency_overrides.clear()
    
    @pytest.fixture
    def client(self):
        """Create test client"""
        return TestClient(app)
    
    @pytest.fixture
    def mock_config_service(self, tmp_path):
        """Create a mock ConfigService"""
        env_file = tmp_path / ".env"
        env_file.touch()
        service = ConfigService(str(env_file))
        # Override dependency
        app.dependency_overrides[get_config_service] = lambda: service
        return service
    
    @pytest.fixture
    def mock_model_checker(self, mock_config_service):
        """Create a mock ModelChecker"""
        checker = Mock(spec=ModelChecker)
        # Override dependency
        app.dependency_overrides[get_model_checker] = lambda: checker
        return checker
    
    @pytest.fixture
    def sample_models(self):
        """Sample model data"""
        return [
            {
                "id": "llama2-70b-4096",
                "name": "llama2-70b-4096",
                "provider": "groq",
                "context_window": 4096,
                "supports_streaming": True,
                "langchain_class": "ChatGroq",
                "owned_by": "groq",
                "created": 1234567890
            },
            {
                "id": "mixtral-8x7b-32768",
                "name": "mixtral-8x7b-32768",
                "provider": "groq",
                "context_window": 32768,
                "supports_streaming": True,
                "langchain_class": "ChatGroq",
                "owned_by": "groq",
                "created": 1234567891
            }
        ]
    
    # POST /api/config/token Tests
    
    def test_save_groq_token_success(self, client, mock_config_service):
        """Test successfully saving a Groq API token"""
        response = client.post(
            "/api/config/token",
            json={
                "provider": "groq",
                "token": "gsk_test1234567890abcdefghijklmnopqrstuvwxyz1234567890"
            }
        )
        
        assert response.status_code == 200
        data = response.json()
        assert data["status"] == "success"
        assert data["provider"] == "groq"
        assert "successfully" in data["message"].lower()
    
    def test_save_openai_token_success(self, client, mock_config_service):
        """Test successfully saving an OpenAI API token"""
        response = client.post(
            "/api/config/token",
            json={
                "provider": "openai",
                "token": "sk-test1234567890abcdefghijklmnopqrstuvwxyz123456789012"
            }
        )
        
        assert response.status_code == 200
        data = response.json()
        assert data["status"] == "success"
        assert data["provider"] == "openai"
    
    def test_save_token_invalid_format(self, client, mock_config_service):
        """Test saving token with invalid format"""
        response = client.post(
            "/api/config/token",
            json={
                "provider": "groq",
                "token": "invalid_token_format"
            }
        )
        
        assert response.status_code == 400
        assert "invalid token format" in response.json()["detail"].lower()
    
    def test_save_token_invalid_provider(self, client):
        """Test saving token with invalid provider"""
        response = client.post(
            "/api/config/token",
            json={
                "provider": "invalid_provider",
                "token": "gsk_test1234567890abcdefghijklmnopqrstuvwxyz1234567890"
            }
        )
        
        assert response.status_code == 422  # Pydantic validation error
    
    def test_save_token_missing_fields(self, client):
        """Test saving token with missing required fields"""
        response = client.post(
            "/api/config/token",
            json={"provider": "groq"}
        )
        
        assert response.status_code == 422
    
    def test_save_token_short_token(self, client):
        """Test saving token that's too short"""
        response = client.post(
            "/api/config/token",
            json={
                "provider": "groq",
                "token": "short"
            }
        )
        
        assert response.status_code == 422
    
    # GET /api/config/models Tests
    
    @pytest.mark.asyncio
    async def test_get_models_success(self, client, mock_config_service, sample_models):
        """Test successfully fetching models"""
        mock_config_service.save_token("groq", "gsk_test1234567890abcdefghijklmnopqrstuvwxyz1234567890")
        
        mock_checker = Mock(spec=ModelChecker)
        mock_checker.get_cached_models.return_value = None
        mock_checker.fetch_models = AsyncMock(return_value=sample_models)
        
                response = client.get("/api/config/models?provider=groq")
                
                assert response.status_code == 200
                data = response.json()
                assert data["provider"] == "groq"
                assert len(data["models"]) == 2
                assert data["models"][0]["id"] == "llama2-70b-4096"
                assert data["cached"] == False
    
    def test_get_models_from_cache(self, client, mock_config_service, sample_models):
        """Test fetching models from cache"""
        mock_config_service.save_token("groq", "gsk_test1234567890abcdefghijklmnopqrstuvwxyz1234567890")
        
        mock_checker = Mock(spec=ModelChecker)
        mock_checker.get_cached_models.return_value = sample_models
        
                response = client.get("/api/config/models?provider=groq")
                
                assert response.status_code == 200
                data = response.json()
                assert data["cached"] == True
                assert len(data["models"]) == 2
    
    def test_get_models_no_token(self, client, mock_config_service):
        """Test fetching models without token configured"""
        mock_checker = Mock(spec=ModelChecker)
        
                response = client.get("/api/config/models?provider=groq")
                
                assert response.status_code == 401
                assert "no api token configured" in response.json()["detail"].lower()
    
    def test_get_models_invalid_provider(self, client):
        """Test fetching models with invalid provider"""
        response = client.get("/api/config/models?provider=invalid")
        
        assert response.status_code == 400
        assert "must be either" in response.json()["detail"].lower()
    
    @pytest.mark.asyncio
    async def test_get_models_force_refresh(self, client, mock_config_service, sample_models):
        """Test fetching models with force refresh"""
        mock_config_service.save_token("groq", "gsk_test1234567890abcdefghijklmnopqrstuvwxyz1234567890")
        
        mock_checker = Mock(spec=ModelChecker)
        mock_checker.get_cached_models.return_value = None
        mock_checker.invalidate_cache = Mock()
        mock_checker.fetch_models = AsyncMock(return_value=sample_models)
        
                response = client.get("/api/config/models?provider=groq&force_refresh=true")
                
                assert response.status_code == 200
                mock_checker.invalidate_cache.assert_called_once_with("groq")
    
    # POST /api/config/model/select Tests
    
    def test_select_model_success(self, client, mock_config_service):
        """Test successfully selecting a model"""
        mock_config_service.save_token("groq", "gsk_test1234567890abcdefghijklmnopqrstuvwxyz1234567890")
        
        mock_checker = Mock(spec=ModelChecker)
        mock_checker.validate_model_selection.return_value = True
        
                response = client.post(
                    "/api/config/model/select",
                    json={
                        "provider": "groq",
                        "model_id": "llama2-70b-4096"
                    }
                )
                
                assert response.status_code == 200
                data = response.json()
                assert data["status"] == "success"
                assert data["provider"] == "groq"
                assert data["model_id"] == "llama2-70b-4096"
    
    def test_select_model_invalid_model(self, client, mock_config_service):
        """Test selecting invalid model"""
        mock_config_service.save_token("groq", "gsk_test1234567890abcdefghijklmnopqrstuvwxyz1234567890")
        
        mock_checker = Mock(spec=ModelChecker)
        mock_checker.validate_model_selection.return_value = False
        
                response = client.post(
                    "/api/config/model/select",
                    json={
                        "provider": "groq",
                        "model_id": "non-existent-model"
                    }
                )
                
                assert response.status_code == 400
                assert "not found" in response.json()["detail"].lower()
    
    def test_select_model_no_token(self, client, mock_config_service):
        """Test selecting model without token configured"""
        mock_checker = Mock(spec=ModelChecker)
        
                response = client.post(
                    "/api/config/model/select",
                    json={
                        "provider": "groq",
                        "model_id": "llama2-70b-4096"
                    }
                )
                
                assert response.status_code == 401
    
    def test_select_model_invalid_provider(self, client):
        """Test selecting model with invalid provider"""
        response = client.post(
            "/api/config/model/select",
            json={
                "provider": "invalid",
                "model_id": "some-model"
            }
        )
        
        assert response.status_code == 422
    
    # GET /api/config/status Tests
    
    def test_get_config_status_with_tokens(self, client, mock_config_service):
        """Test getting configuration status with tokens configured"""
        mock_config_service.save_token("groq", "gsk_test1234567890abcdefghijklmnopqrstuvwxyz1234567890")
        mock_config_service.save_token("openai", "sk-test1234567890abcdefghijklmnopqrstuvwxyz123456789012")
        mock_config_service.switch_provider("groq")
        mock_config_service.save_selected_model("groq", "llama2-70b-4096")
        
            response = client.get("/api/config/status")
            
            assert response.status_code == 200
            data = response.json()
            assert data["active_provider"] == "groq"
            assert data["has_groq_token"] == True
            assert data["has_openai_token"] == True
            assert data["selected_model"] == "llama2-70b-4096"
    
    def test_get_config_status_no_configuration(self, client, mock_config_service):
        """Test getting configuration status with no configuration"""
            response = client.get("/api/config/status")
            
            assert response.status_code == 200
            data = response.json()
            assert data["active_provider"] is None
            assert data["has_groq_token"] == False
            assert data["has_openai_token"] == False
            assert data["selected_model"] is None
    
    # DELETE /api/config/token/{provider} Tests
    
    def test_delete_token_success(self, client, mock_config_service):
        """Test successfully deleting a token"""
        mock_config_service.save_token("groq", "gsk_test1234567890abcdefghijklmnopqrstuvwxyz1234567890")
        
            response = client.delete("/api/config/token/groq")
            
            assert response.status_code == 204
            # Verify token was deleted
            assert not mock_config_service.get_token("groq")
    
    def test_delete_token_invalid_provider(self, client, mock_config_service):
        """Test deleting token with invalid provider"""
            response = client.delete("/api/config/token/invalid")
            
            assert response.status_code == 400
    
    # Integration Tests
    
    def test_full_configuration_flow(self, client, mock_config_service, sample_models):
        """Test complete configuration flow"""
        mock_checker = Mock(spec=ModelChecker)
        mock_checker.get_cached_models.return_value = None
        mock_checker.fetch_models = AsyncMock(return_value=sample_models)
        mock_checker.validate_model_selection.return_value = True
        
                # 1. Save token
                response = client.post(
                    "/api/config/token",
                    json={"provider": "groq", "token": "gsk_test1234567890abcdefghijklmnopqrstuvwxyz1234567890"}
                )
                assert response.status_code == 200
                
                # 2. Get models
                response = client.get("/api/config/models?provider=groq")
                assert response.status_code == 200
                assert len(response.json()["models"]) == 2
                
                # 3. Select model
                response = client.post(
                    "/api/config/model/select",
                    json={"provider": "groq", "model_id": "llama2-70b-4096"}
                )
                assert response.status_code == 200
                
                # 4. Check status
                response = client.get("/api/config/status")
                assert response.status_code == 200
                data = response.json()
                assert data["active_provider"] == "groq"
                assert data["has_groq_token"] == True
    
    def test_request_validation_errors(self, client):
        """Test various request validation errors"""
        # Missing required field
        response = client.post("/api/config/token", json={"provider": "groq"})
        assert response.status_code == 422
        
        # Invalid JSON
        response = client.post(
            "/api/config/token",
            data="invalid json",
            headers={"Content-Type": "application/json"}
        )
        assert response.status_code == 422
        
        # Wrong data type
        response = client.post(
            "/api/config/token",
            json={"provider": "groq", "token": 12345}
        )
        assert response.status_code == 422
